name: Deploy All Services

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy to'
        required: true
        default: 'staging'
        type: choice
        options:
        - staging
        - production

env:
  AWS_REGION: us-west-2
  ECR_REGISTRY: ${{ secrets.ECR_REGISTRY }}
  ENVIRONMENT: ${{ github.event.inputs.environment }}

jobs:
  deploy-all-services:
    name: 🚀 Deploy All Services
    runs-on: ubuntu-latest
    strategy:
      matrix:
        service: [ui, catalog, orders, checkout, cart, app]
      fail-fast: false
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Login to Amazon ECR
        uses: aws-actions/amazon-ecr-login@v2

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build and push ${{ matrix.service }} Docker image
        uses: docker/build-push-action@v5
        with:
          context: ./src/${{ matrix.service }}
          push: true
          tags: |
            ${{ env.ECR_REGISTRY }}/retail-store-${{ matrix.service }}:${{ github.sha }}
            ${{ env.ECR_REGISTRY }}/retail-store-${{ matrix.service }}:latest
            ${{ env.ECR_REGISTRY }}/retail-store-${{ matrix.service }}:${{ env.ENVIRONMENT }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Verify ${{ matrix.service }} image push
        run: |
          echo "✅ Successfully built and pushed retail-store-${{ matrix.service }}:${{ github.sha }}"
          aws ecr describe-images --repository-name retail-store-${{ matrix.service }} --image-ids imageTag=${{ github.sha }} --region ${{ env.AWS_REGION }}

  update-helm-charts:
    name: ⚙️ Update All Helm Charts
    needs: deploy-all-services
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Update all Helm values
        run: |
          services=("ui" "catalog" "orders" "checkout" "cart" "app")
          
          echo "🔄 Updating Helm values for all services..."
          
          for service in "${services[@]}"; do
            if [ -f "src/$service/chart/values.yaml" ]; then
              echo "Updating $service..."
              sed -i "s|tag: .*|tag: \"${{ github.sha }}\"|g" "src/$service/chart/values.yaml"
              echo "✅ Updated $service"
            else
              echo "⚠️ No Helm chart found for $service"
            fi
          done

      - name: Commit Helm changes
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          
          git add src/*/chart/values.yaml
          
          if git diff --staged --quiet; then
            echo "ℹ️ No Helm changes to commit"
          else
            git commit -m "🚀 Deploy All Services: Update image tags to ${{ github.sha }}

            Environment: ${{ env.ENVIRONMENT }}
            Services: ui, catalog, orders, checkout, cart, app
            Commit: ${{ github.sha }}"
            git push
            echo "✅ All Helm charts updated"
          fi

  deploy-to-kubernetes:
    name: 🎯 Deploy to Kubernetes
    needs: [deploy-all-services, update-helm-charts]
    runs-on: ubuntu-latest
    if: ${{ secrets.EKS_CLUSTER_NAME != '' }}
    strategy:
      matrix:
        service: [ui, catalog, orders, checkout, cart, app]
      fail-fast: false
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Update kubeconfig
        run: |
          aws eks update-kubeconfig --region ${{ env.AWS_REGION }} --name ${{ secrets.EKS_CLUSTER_NAME }}

      - name: Install Helm
        uses: azure/setup-helm@v3
        with:
          version: '3.12.0'

      - name: Deploy ${{ matrix.service }} to Kubernetes
        run: |
          service="${{ matrix.service }}"
          namespace="retail-store-${{ env.ENVIRONMENT }}"
          release_name="retail-store-$service"
          
          echo "🚀 Deploying $service to $namespace..."
          
          # Create namespace if it doesn't exist
          kubectl create namespace $namespace --dry-run=client -o yaml | kubectl apply -f -
          
          # Deploy with Helm if chart exists
          if [ -d "./src/$service/chart" ]; then
            helm upgrade --install $release_name ./src/$service/chart \
              --namespace $namespace \
              --set image.tag=${{ github.sha }} \
              --set environment=${{ env.ENVIRONMENT }} \
              --wait --timeout=10m
            echo "✅ $service deployed with Helm"
          else
            echo "⚠️ No Helm chart found for $service, skipping Kubernetes deployment"
          fi

      - name: Verify ${{ matrix.service }} deployment
        run: |
          service="${{ matrix.service }}"
          namespace="retail-store-${{ env.ENVIRONMENT }}"
          
          echo "🔍 Verifying deployment for $service..."
          
          # Check if deployment exists
          if kubectl get deployment retail-store-$service -n $namespace > /dev/null 2>&1; then
            kubectl wait --for=condition=available --timeout=300s deployment/retail-store-$service -n $namespace || true
            kubectl get deployment retail-store-$service -n $namespace -o wide
            kubectl get pods -n $namespace -l app.kubernetes.io/name=retail-store-$service
          else
            echo "ℹ️ No Kubernetes deployment found for $service"
          fi

  deployment-summary:
    name: 📊 Final Deployment Summary
    needs: [deploy-all-services, update-helm-charts, deploy-to-kubernetes]
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: Generate comprehensive summary
        run: |
          echo "# 🎉 All Services Deployment Complete!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Environment:** ${{ env.ENVIRONMENT }}" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "**Timestamp:** $(date)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "## 🚀 Services Deployed" >> $GITHUB_STEP_SUMMARY
          services=("ui" "catalog" "orders" "checkout" "cart" "app")
          for service in "${services[@]}"; do
            echo "- **$service**: \`${{ env.ECR_REGISTRY }}/retail-store-$service:${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
          done
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## 📋 Job Status" >> $GITHUB_STEP_SUMMARY
          echo "- 🐳 Build & Push: ${{ needs.deploy-all-services.result == 'success' && '✅ Success' || '❌ Failed' }}" >> $GITHUB_STEP_SUMMARY
          echo "- ⚙️ Update Helm: ${{ needs.update-helm-charts.result == 'success' && '✅ Success' || '❌ Failed' }}" >> $GITHUB_STEP_SUMMARY
          echo "- 🎯 Deploy K8s: ${{ needs.deploy-to-kubernetes.result == 'success' && '✅ Success' || needs.deploy-to-kubernetes.result == 'skipped' && '⏭️ Skipped' || '❌ Failed' }}" >> $GITHUB_STEP_SUMMARY
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## 🔗 Quick Commands" >> $GITHUB_STEP_SUMMARY
          echo '```bash' >> $GITHUB_STEP_SUMMARY
          echo "# Check all pods" >> $GITHUB_STEP_SUMMARY
          echo "kubectl get pods -n retail-store-${{ env.ENVIRONMENT }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "# Check all services" >> $GITHUB_STEP_SUMMARY
          echo "kubectl get svc -n retail-store-${{ env.ENVIRONMENT }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "# Get application URL" >> $GITHUB_STEP_SUMMARY
          echo "kubectl get svc -n ingress-nginx ingress-nginx-controller" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "🎊 **All services are now deployed and ready!**" >> $GITHUB_STEP_SUMMARY
